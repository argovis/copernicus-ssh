use netcdf;
use chrono::Utc;
use chrono::TimeZone;
use chrono::Duration;
use chrono::Datelike;
use chrono::Timelike;
use chrono::DateTime;
use std::env;
use std::error::Error;

fn tidylon(longitude: f64) -> f64{
    // map longitude on [0,360] to [-180,180], required for mongo indexing
    if longitude <= 180.0{
        return longitude;
    }
    else{
        return longitude-360.0;
    }
}

fn nowstring() -> String{
    // returns a String representing the current ISO8601 datetime

    let now = Utc::now();
    return format!("{}-{:02}-{:02}T{:02}:{:02}:{:02}Z", now.year(), now.month(), now.day(), now.hour(), now.minute(), now.second());
}

// impementing a foreign trait on a forein struct //////////
// per the advice in https://stackoverflow.com/questions/76277096/deconstructing-enums-in-rust/76277117#76277117

struct Wrapper{
    s: String
}

impl std::convert::TryFrom<netcdf::attribute::AttrValue> for Wrapper {
    type Error = &'static str;

    fn try_from(value: netcdf::attribute::AttrValue) -> Result<Self, Self::Error> {

        if let netcdf::attribute::AttrValue::Str(v) = value {
            Ok(Wrapper{s: String::from(v)} )
        } else {
            Err("nope")
        }
    }
}
////////////////////

fn find_basin(basins: &netcdf::Variable, longitude: f64, latitude: f64) -> i32 {    
    let lonplus = (longitude-0.5).ceil()+0.5;
    let lonminus = (longitude-0.5).floor()+0.5;
    let latplus = (latitude-0.5).ceil()+0.5;
    let latminus = (latitude-0.5).floor()+0.5;

    let lonplus_idx = (lonplus - -179.5) as usize;
    let lonminus_idx = (lonminus - -179.5) as usize;
    let latplus_idx = (latplus - -77.5) as usize;
    let latminus_idx = (latminus - -77.5) as usize;

    let corners_idx = [
        // bottom left corner, clockwise
        [latminus_idx, lonminus_idx],
        [latplus_idx, lonminus_idx],
        [latplus_idx, lonplus_idx],
        [latminus_idx, lonplus_idx]
    ];

    let distances = [
        (f64::powi(longitude-lonminus, 2) + f64::powi(latitude-latminus, 2)).sqrt(),
        (f64::powi(longitude-lonminus, 2) + f64::powi(latitude-latplus, 2)).sqrt(),
        (f64::powi(longitude-lonplus, 2) + f64::powi(latitude-latplus, 2)).sqrt(),
        (f64::powi(longitude-lonplus, 2) + f64::powi(latitude-latminus, 2)).sqrt()
    ];

    let mut closecorner_idx = corners_idx[0];
    let mut closedist = distances[0];
    for i in 1..4 {
        if distances[i] < closedist{
            closecorner_idx = corners_idx[i];
            closedist = distances[i];
        }
    }

    match basins.value::<i64,_>(closecorner_idx){
        Ok(idx) => idx as i32,
        Err(e) => panic!("basin problems: {:?} {:#?}", e, closecorner_idx)
    }   
}

fn timewindow(center: &str, radius: i64) -> Vec<String> {
    // given a string specifying the central date in the format "1993-02-07T00:00:00.000Z",
    // produce a list of strings for the days +- radius around that date in the format yyyymmdd

    let rfc3339 = DateTime::parse_from_rfc3339(center).unwrap();
    let mut dates = Vec::new();
    for i in -1*radius..radius+1 {
        let d = rfc3339 + Duration::days(i);
        dates.push(format!("{}{:02}{:02}", d.year(), d.month(), d.day()));
    }

    return dates
    
}

fn main() -> Result<(),netcdf::error::Error> {

    //let timelattice = ["1993-01-10T00:00:00.000Z","1993-01-17T00:00:00.000Z","1993-01-24T00:00:00.000Z","1993-01-31T00:00:00.000Z","1993-02-07T00:00:00.000Z","1993-02-14T00:00:00.000Z","1993-02-21T00:00:00.000Z","1993-02-28T00:00:00.000Z","1993-03-07T00:00:00.000Z","1993-03-14T00:00:00.000Z","1993-03-21T00:00:00.000Z","1993-03-28T00:00:00.000Z","1993-04-04T00:00:00.000Z","1993-04-11T00:00:00.000Z","1993-04-18T00:00:00.000Z","1993-04-25T00:00:00.000Z","1993-05-02T00:00:00.000Z","1993-05-09T00:00:00.000Z","1993-05-16T00:00:00.000Z","1993-05-23T00:00:00.000Z","1993-05-30T00:00:00.000Z","1993-06-06T00:00:00.000Z","1993-06-13T00:00:00.000Z","1993-06-20T00:00:00.000Z","1993-06-27T00:00:00.000Z","1993-07-04T00:00:00.000Z","1993-07-11T00:00:00.000Z","1993-07-18T00:00:00.000Z","1993-07-25T00:00:00.000Z","1993-08-01T00:00:00.000Z","1993-08-08T00:00:00.000Z","1993-08-15T00:00:00.000Z","1993-08-22T00:00:00.000Z","1993-08-29T00:00:00.000Z","1993-09-05T00:00:00.000Z","1993-09-12T00:00:00.000Z","1993-09-19T00:00:00.000Z","1993-09-26T00:00:00.000Z","1993-10-03T00:00:00.000Z","1993-10-10T00:00:00.000Z","1993-10-17T00:00:00.000Z","1993-10-24T00:00:00.000Z","1993-10-31T00:00:00.000Z","1993-11-07T00:00:00.000Z","1993-11-14T00:00:00.000Z","1993-11-21T00:00:00.000Z","1993-11-28T00:00:00.000Z","1993-12-05T00:00:00.000Z","1993-12-12T00:00:00.000Z","1993-12-19T00:00:00.000Z","1993-12-26T00:00:00.000Z", "1994-01-02T00:00:00.000Z","1994-01-09T00:00:00.000Z","1994-01-16T00:00:00.000Z","1994-01-23T00:00:00.000Z","1994-01-30T00:00:00.000Z","1994-02-06T00:00:00.000Z","1994-02-13T00:00:00.000Z","1994-02-20T00:00:00.000Z","1994-02-27T00:00:00.000Z","1994-03-06T00:00:00.000Z","1994-03-13T00:00:00.000Z","1994-03-20T00:00:00.000Z","1994-03-27T00:00:00.000Z","1994-04-03T00:00:00.000Z","1994-04-10T00:00:00.000Z","1994-04-17T00:00:00.000Z","1994-04-24T00:00:00.000Z","1994-05-01T00:00:00.000Z","1994-05-08T00:00:00.000Z","1994-05-15T00:00:00.000Z","1994-05-22T00:00:00.000Z","1994-05-29T00:00:00.000Z","1994-06-05T00:00:00.000Z","1994-06-12T00:00:00.000Z","1994-06-19T00:00:00.000Z","1994-06-26T00:00:00.000Z","1994-07-03T00:00:00.000Z","1994-07-10T00:00:00.000Z","1994-07-17T00:00:00.000Z","1994-07-24T00:00:00.000Z","1994-07-31T00:00:00.000Z","1994-08-07T00:00:00.000Z","1994-08-14T00:00:00.000Z","1994-08-21T00:00:00.000Z","1994-08-28T00:00:00.000Z","1994-09-04T00:00:00.000Z","1994-09-11T00:00:00.000Z","1994-09-18T00:00:00.000Z","1994-09-25T00:00:00.000Z","1994-10-02T00:00:00.000Z","1994-10-09T00:00:00.000Z","1994-10-16T00:00:00.000Z","1994-10-23T00:00:00.000Z","1994-10-30T00:00:00.000Z","1994-11-06T00:00:00.000Z","1994-11-13T00:00:00.000Z","1994-11-20T00:00:00.000Z","1994-11-27T00:00:00.000Z","1994-12-04T00:00:00.000Z","1994-12-11T00:00:00.000Z","1994-12-18T00:00:00.000Z","1994-12-25T00:00:00.000Z"];
    //let timelattice = ["1995-01-01T00:00:00.000Z","1995-01-08T00:00:00.000Z","1995-01-15T00:00:00.000Z","1995-01-22T00:00:00.000Z","1995-01-29T00:00:00.000Z","1995-02-05T00:00:00.000Z","1995-02-12T00:00:00.000Z","1995-02-19T00:00:00.000Z","1995-02-26T00:00:00.000Z","1995-03-05T00:00:00.000Z","1995-03-12T00:00:00.000Z","1995-03-19T00:00:00.000Z","1995-03-26T00:00:00.000Z","1995-04-02T00:00:00.000Z","1995-04-09T00:00:00.000Z","1995-04-16T00:00:00.000Z","1995-04-23T00:00:00.000Z","1995-04-30T00:00:00.000Z","1995-05-07T00:00:00.000Z","1995-05-14T00:00:00.000Z","1995-05-21T00:00:00.000Z","1995-05-28T00:00:00.000Z","1995-06-04T00:00:00.000Z","1995-06-11T00:00:00.000Z","1995-06-18T00:00:00.000Z","1995-06-25T00:00:00.000Z","1995-07-02T00:00:00.000Z","1995-07-09T00:00:00.000Z","1995-07-16T00:00:00.000Z","1995-07-23T00:00:00.000Z","1995-07-30T00:00:00.000Z","1995-08-06T00:00:00.000Z","1995-08-13T00:00:00.000Z","1995-08-20T00:00:00.000Z","1995-08-27T00:00:00.000Z","1995-09-03T00:00:00.000Z","1995-09-10T00:00:00.000Z","1995-09-17T00:00:00.000Z","1995-09-24T00:00:00.000Z","1995-10-01T00:00:00.000Z","1995-10-08T00:00:00.000Z","1995-10-15T00:00:00.000Z","1995-10-22T00:00:00.000Z","1995-10-29T00:00:00.000Z","1995-11-05T00:00:00.000Z","1995-11-12T00:00:00.000Z","1995-11-19T00:00:00.000Z","1995-11-26T00:00:00.000Z","1995-12-03T00:00:00.000Z","1995-12-10T00:00:00.000Z","1995-12-17T00:00:00.000Z","1995-12-24T00:00:00.000Z","1995-12-31T00:00:00.000Z","1996-01-07T00:00:00.000Z","1996-01-14T00:00:00.000Z","1996-01-21T00:00:00.000Z","1996-01-28T00:00:00.000Z","1996-02-04T00:00:00.000Z","1996-02-11T00:00:00.000Z","1996-02-18T00:00:00.000Z","1996-02-25T00:00:00.000Z","1996-03-03T00:00:00.000Z","1996-03-10T00:00:00.000Z","1996-03-17T00:00:00.000Z","1996-03-24T00:00:00.000Z","1996-03-31T00:00:00.000Z","1996-04-07T00:00:00.000Z","1996-04-14T00:00:00.000Z","1996-04-21T00:00:00.000Z","1996-04-28T00:00:00.000Z","1996-05-05T00:00:00.000Z","1996-05-12T00:00:00.000Z","1996-05-19T00:00:00.000Z","1996-05-26T00:00:00.000Z","1996-06-02T00:00:00.000Z","1996-06-09T00:00:00.000Z","1996-06-16T00:00:00.000Z","1996-06-23T00:00:00.000Z","1996-06-30T00:00:00.000Z","1996-07-07T00:00:00.000Z","1996-07-14T00:00:00.000Z","1996-07-21T00:00:00.000Z","1996-07-28T00:00:00.000Z","1996-08-04T00:00:00.000Z","1996-08-11T00:00:00.000Z","1996-08-18T00:00:00.000Z","1996-08-25T00:00:00.000Z","1996-09-01T00:00:00.000Z","1996-09-08T00:00:00.000Z","1996-09-15T00:00:00.000Z","1996-09-22T00:00:00.000Z","1996-09-29T00:00:00.000Z","1996-10-06T00:00:00.000Z","1996-10-13T00:00:00.000Z","1996-10-20T00:00:00.000Z","1996-10-27T00:00:00.000Z","1996-11-03T00:00:00.000Z","1996-11-10T00:00:00.000Z","1996-11-17T00:00:00.000Z","1996-11-24T00:00:00.000Z","1996-12-01T00:00:00.000Z","1996-12-08T00:00:00.000Z","1996-12-15T00:00:00.000Z","1996-12-22T00:00:00.000Z","1996-12-29T00:00:00.000Z"];
    //let timelattice = ["1997-01-05T00:00:00.000Z","1997-01-12T00:00:00.000Z","1997-01-19T00:00:00.000Z","1997-01-26T00:00:00.000Z","1997-02-02T00:00:00.000Z","1997-02-09T00:00:00.000Z","1997-02-16T00:00:00.000Z","1997-02-23T00:00:00.000Z","1997-03-02T00:00:00.000Z","1997-03-09T00:00:00.000Z","1997-03-16T00:00:00.000Z","1997-03-23T00:00:00.000Z","1997-03-30T00:00:00.000Z","1997-04-06T00:00:00.000Z","1997-04-13T00:00:00.000Z","1997-04-20T00:00:00.000Z","1997-04-27T00:00:00.000Z","1997-05-04T00:00:00.000Z","1997-05-11T00:00:00.000Z","1997-05-18T00:00:00.000Z","1997-05-25T00:00:00.000Z","1997-06-01T00:00:00.000Z","1997-06-08T00:00:00.000Z","1997-06-15T00:00:00.000Z","1997-06-22T00:00:00.000Z","1997-06-29T00:00:00.000Z","1997-07-06T00:00:00.000Z","1997-07-13T00:00:00.000Z","1997-07-20T00:00:00.000Z","1997-07-27T00:00:00.000Z","1997-08-03T00:00:00.000Z","1997-08-10T00:00:00.000Z","1997-08-17T00:00:00.000Z","1997-08-24T00:00:00.000Z","1997-08-31T00:00:00.000Z","1997-09-07T00:00:00.000Z","1997-09-14T00:00:00.000Z","1997-09-21T00:00:00.000Z","1997-09-28T00:00:00.000Z","1997-10-05T00:00:00.000Z","1997-10-12T00:00:00.000Z","1997-10-19T00:00:00.000Z","1997-10-26T00:00:00.000Z","1997-11-02T00:00:00.000Z","1997-11-09T00:00:00.000Z","1997-11-16T00:00:00.000Z","1997-11-23T00:00:00.000Z","1997-11-30T00:00:00.000Z","1997-12-07T00:00:00.000Z","1997-12-14T00:00:00.000Z","1997-12-21T00:00:00.000Z","1997-12-28T00:00:00.000Z","1998-01-04T00:00:00.000Z","1998-01-11T00:00:00.000Z","1998-01-18T00:00:00.000Z","1998-01-25T00:00:00.000Z","1998-02-01T00:00:00.000Z","1998-02-08T00:00:00.000Z","1998-02-15T00:00:00.000Z","1998-02-22T00:00:00.000Z","1998-03-01T00:00:00.000Z","1998-03-08T00:00:00.000Z","1998-03-15T00:00:00.000Z","1998-03-22T00:00:00.000Z","1998-03-29T00:00:00.000Z","1998-04-05T00:00:00.000Z","1998-04-12T00:00:00.000Z","1998-04-19T00:00:00.000Z","1998-04-26T00:00:00.000Z","1998-05-03T00:00:00.000Z","1998-05-10T00:00:00.000Z","1998-05-17T00:00:00.000Z","1998-05-24T00:00:00.000Z","1998-05-31T00:00:00.000Z","1998-06-07T00:00:00.000Z","1998-06-14T00:00:00.000Z","1998-06-21T00:00:00.000Z","1998-06-28T00:00:00.000Z","1998-07-05T00:00:00.000Z","1998-07-12T00:00:00.000Z","1998-07-19T00:00:00.000Z","1998-07-26T00:00:00.000Z","1998-08-02T00:00:00.000Z","1998-08-09T00:00:00.000Z","1998-08-16T00:00:00.000Z","1998-08-23T00:00:00.000Z","1998-08-30T00:00:00.000Z","1998-09-06T00:00:00.000Z","1998-09-13T00:00:00.000Z","1998-09-20T00:00:00.000Z","1998-09-27T00:00:00.000Z","1998-10-04T00:00:00.000Z","1998-10-11T00:00:00.000Z","1998-10-18T00:00:00.000Z","1998-10-25T00:00:00.000Z","1998-11-01T00:00:00.000Z","1998-11-08T00:00:00.000Z","1998-11-15T00:00:00.000Z","1998-11-22T00:00:00.000Z","1998-11-29T00:00:00.000Z","1998-12-06T00:00:00.000Z","1998-12-13T00:00:00.000Z","1998-12-20T00:00:00.000Z","1998-12-27T00:00:00.000Z"];
    //let timelattice = ["1999-01-03T00:00:00.000Z","1999-01-10T00:00:00.000Z","1999-01-17T00:00:00.000Z","1999-01-24T00:00:00.000Z","1999-01-31T00:00:00.000Z","1999-02-07T00:00:00.000Z","1999-02-14T00:00:00.000Z","1999-02-21T00:00:00.000Z","1999-02-28T00:00:00.000Z","1999-03-07T00:00:00.000Z","1999-03-14T00:00:00.000Z","1999-03-21T00:00:00.000Z","1999-03-28T00:00:00.000Z","1999-04-04T00:00:00.000Z","1999-04-11T00:00:00.000Z","1999-04-18T00:00:00.000Z","1999-04-25T00:00:00.000Z","1999-05-02T00:00:00.000Z","1999-05-09T00:00:00.000Z","1999-05-16T00:00:00.000Z","1999-05-23T00:00:00.000Z","1999-05-30T00:00:00.000Z","1999-06-06T00:00:00.000Z","1999-06-13T00:00:00.000Z","1999-06-20T00:00:00.000Z","1999-06-27T00:00:00.000Z","1999-07-04T00:00:00.000Z","1999-07-11T00:00:00.000Z","1999-07-18T00:00:00.000Z","1999-07-25T00:00:00.000Z","1999-08-01T00:00:00.000Z","1999-08-08T00:00:00.000Z","1999-08-15T00:00:00.000Z","1999-08-22T00:00:00.000Z","1999-08-29T00:00:00.000Z","1999-09-05T00:00:00.000Z","1999-09-12T00:00:00.000Z","1999-09-19T00:00:00.000Z","1999-09-26T00:00:00.000Z","1999-10-03T00:00:00.000Z","1999-10-10T00:00:00.000Z","1999-10-17T00:00:00.000Z","1999-10-24T00:00:00.000Z","1999-10-31T00:00:00.000Z","1999-11-07T00:00:00.000Z","1999-11-14T00:00:00.000Z","1999-11-21T00:00:00.000Z","1999-11-28T00:00:00.000Z","1999-12-05T00:00:00.000Z","1999-12-12T00:00:00.000Z","1999-12-19T00:00:00.000Z","1999-12-26T00:00:00.000Z","2000-01-02T00:00:00.000Z","2000-01-09T00:00:00.000Z","2000-01-16T00:00:00.000Z","2000-01-23T00:00:00.000Z","2000-01-30T00:00:00.000Z","2000-02-06T00:00:00.000Z","2000-02-13T00:00:00.000Z","2000-02-20T00:00:00.000Z","2000-02-27T00:00:00.000Z","2000-03-05T00:00:00.000Z","2000-03-12T00:00:00.000Z","2000-03-19T00:00:00.000Z","2000-03-26T00:00:00.000Z","2000-04-02T00:00:00.000Z","2000-04-09T00:00:00.000Z","2000-04-16T00:00:00.000Z","2000-04-23T00:00:00.000Z","2000-04-30T00:00:00.000Z","2000-05-07T00:00:00.000Z","2000-05-14T00:00:00.000Z","2000-05-21T00:00:00.000Z","2000-05-28T00:00:00.000Z","2000-06-04T00:00:00.000Z","2000-06-11T00:00:00.000Z","2000-06-18T00:00:00.000Z","2000-06-25T00:00:00.000Z","2000-07-02T00:00:00.000Z","2000-07-09T00:00:00.000Z","2000-07-16T00:00:00.000Z","2000-07-23T00:00:00.000Z","2000-07-30T00:00:00.000Z","2000-08-06T00:00:00.000Z","2000-08-13T00:00:00.000Z","2000-08-20T00:00:00.000Z","2000-08-27T00:00:00.000Z","2000-09-03T00:00:00.000Z","2000-09-10T00:00:00.000Z","2000-09-17T00:00:00.000Z","2000-09-24T00:00:00.000Z","2000-10-01T00:00:00.000Z","2000-10-08T00:00:00.000Z","2000-10-15T00:00:00.000Z","2000-10-22T00:00:00.000Z","2000-10-29T00:00:00.000Z","2000-11-05T00:00:00.000Z","2000-11-12T00:00:00.000Z","2000-11-19T00:00:00.000Z","2000-11-26T00:00:00.000Z","2000-12-03T00:00:00.000Z","2000-12-10T00:00:00.000Z","2000-12-17T00:00:00.000Z","2000-12-24T00:00:00.000Z","2000-12-31T00:00:00.000Z"];
    //let timelattice = ["2001-01-07T00:00:00.000Z","2001-01-14T00:00:00.000Z","2001-01-21T00:00:00.000Z","2001-01-28T00:00:00.000Z","2001-02-04T00:00:00.000Z","2001-02-11T00:00:00.000Z","2001-02-18T00:00:00.000Z","2001-02-25T00:00:00.000Z","2001-03-04T00:00:00.000Z","2001-03-11T00:00:00.000Z","2001-03-18T00:00:00.000Z","2001-03-25T00:00:00.000Z","2001-04-01T00:00:00.000Z","2001-04-08T00:00:00.000Z","2001-04-15T00:00:00.000Z","2001-04-22T00:00:00.000Z","2001-04-29T00:00:00.000Z","2001-05-06T00:00:00.000Z","2001-05-13T00:00:00.000Z","2001-05-20T00:00:00.000Z","2001-05-27T00:00:00.000Z","2001-06-03T00:00:00.000Z","2001-06-10T00:00:00.000Z","2001-06-17T00:00:00.000Z","2001-06-24T00:00:00.000Z","2001-07-01T00:00:00.000Z","2001-07-08T00:00:00.000Z","2001-07-15T00:00:00.000Z","2001-07-22T00:00:00.000Z","2001-07-29T00:00:00.000Z","2001-08-05T00:00:00.000Z","2001-08-12T00:00:00.000Z","2001-08-19T00:00:00.000Z","2001-08-26T00:00:00.000Z","2001-09-02T00:00:00.000Z","2001-09-09T00:00:00.000Z","2001-09-16T00:00:00.000Z","2001-09-23T00:00:00.000Z","2001-09-30T00:00:00.000Z","2001-10-07T00:00:00.000Z","2001-10-14T00:00:00.000Z","2001-10-21T00:00:00.000Z","2001-10-28T00:00:00.000Z","2001-11-04T00:00:00.000Z","2001-11-11T00:00:00.000Z","2001-11-18T00:00:00.000Z","2001-11-25T00:00:00.000Z","2001-12-02T00:00:00.000Z","2001-12-09T00:00:00.000Z","2001-12-16T00:00:00.000Z","2001-12-23T00:00:00.000Z","2001-12-30T00:00:00.000Z","2002-01-06T00:00:00.000Z","2002-01-13T00:00:00.000Z","2002-01-20T00:00:00.000Z","2002-01-27T00:00:00.000Z","2002-02-03T00:00:00.000Z","2002-02-10T00:00:00.000Z","2002-02-17T00:00:00.000Z","2002-02-24T00:00:00.000Z","2002-03-03T00:00:00.000Z","2002-03-10T00:00:00.000Z","2002-03-17T00:00:00.000Z","2002-03-24T00:00:00.000Z","2002-03-31T00:00:00.000Z","2002-04-07T00:00:00.000Z","2002-04-14T00:00:00.000Z","2002-04-21T00:00:00.000Z","2002-04-28T00:00:00.000Z","2002-05-05T00:00:00.000Z","2002-05-12T00:00:00.000Z","2002-05-19T00:00:00.000Z","2002-05-26T00:00:00.000Z","2002-06-02T00:00:00.000Z","2002-06-09T00:00:00.000Z","2002-06-16T00:00:00.000Z","2002-06-23T00:00:00.000Z","2002-06-30T00:00:00.000Z","2002-07-07T00:00:00.000Z","2002-07-14T00:00:00.000Z","2002-07-21T00:00:00.000Z","2002-07-28T00:00:00.000Z","2002-08-04T00:00:00.000Z","2002-08-11T00:00:00.000Z","2002-08-18T00:00:00.000Z","2002-08-25T00:00:00.000Z","2002-09-01T00:00:00.000Z","2002-09-08T00:00:00.000Z","2002-09-15T00:00:00.000Z","2002-09-22T00:00:00.000Z","2002-09-29T00:00:00.000Z","2002-10-06T00:00:00.000Z","2002-10-13T00:00:00.000Z","2002-10-20T00:00:00.000Z","2002-10-27T00:00:00.000Z","2002-11-03T00:00:00.000Z","2002-11-10T00:00:00.000Z","2002-11-17T00:00:00.000Z","2002-11-24T00:00:00.000Z","2002-12-01T00:00:00.000Z","2002-12-08T00:00:00.000Z","2002-12-15T00:00:00.000Z","2002-12-22T00:00:00.000Z","2002-12-29T00:00:00.000Z"];
    //let timelattice = ["2003-01-05T00:00:00.000Z","2003-01-12T00:00:00.000Z","2003-01-19T00:00:00.000Z","2003-01-26T00:00:00.000Z","2003-02-02T00:00:00.000Z","2003-02-09T00:00:00.000Z","2003-02-16T00:00:00.000Z","2003-02-23T00:00:00.000Z","2003-03-02T00:00:00.000Z","2003-03-09T00:00:00.000Z","2003-03-16T00:00:00.000Z","2003-03-23T00:00:00.000Z","2003-03-30T00:00:00.000Z","2003-04-06T00:00:00.000Z","2003-04-13T00:00:00.000Z","2003-04-20T00:00:00.000Z","2003-04-27T00:00:00.000Z","2003-05-04T00:00:00.000Z","2003-05-11T00:00:00.000Z","2003-05-18T00:00:00.000Z","2003-05-25T00:00:00.000Z","2003-06-01T00:00:00.000Z","2003-06-08T00:00:00.000Z","2003-06-15T00:00:00.000Z","2003-06-22T00:00:00.000Z","2003-06-29T00:00:00.000Z","2003-07-06T00:00:00.000Z","2003-07-13T00:00:00.000Z","2003-07-20T00:00:00.000Z","2003-07-27T00:00:00.000Z","2003-08-03T00:00:00.000Z","2003-08-10T00:00:00.000Z","2003-08-17T00:00:00.000Z","2003-08-24T00:00:00.000Z","2003-08-31T00:00:00.000Z","2003-09-07T00:00:00.000Z","2003-09-14T00:00:00.000Z","2003-09-21T00:00:00.000Z","2003-09-28T00:00:00.000Z","2003-10-05T00:00:00.000Z","2003-10-12T00:00:00.000Z","2003-10-19T00:00:00.000Z","2003-10-26T00:00:00.000Z","2003-11-02T00:00:00.000Z","2003-11-09T00:00:00.000Z","2003-11-16T00:00:00.000Z","2003-11-23T00:00:00.000Z","2003-11-30T00:00:00.000Z","2003-12-07T00:00:00.000Z","2003-12-14T00:00:00.000Z","2003-12-21T00:00:00.000Z","2003-12-28T00:00:00.000Z","2004-01-04T00:00:00.000Z","2004-01-11T00:00:00.000Z","2004-01-18T00:00:00.000Z","2004-01-25T00:00:00.000Z","2004-02-01T00:00:00.000Z","2004-02-08T00:00:00.000Z","2004-02-15T00:00:00.000Z","2004-02-22T00:00:00.000Z","2004-02-29T00:00:00.000Z","2004-03-07T00:00:00.000Z","2004-03-14T00:00:00.000Z","2004-03-21T00:00:00.000Z","2004-03-28T00:00:00.000Z","2004-04-04T00:00:00.000Z","2004-04-11T00:00:00.000Z","2004-04-18T00:00:00.000Z","2004-04-25T00:00:00.000Z","2004-05-02T00:00:00.000Z","2004-05-09T00:00:00.000Z","2004-05-16T00:00:00.000Z","2004-05-23T00:00:00.000Z","2004-05-30T00:00:00.000Z","2004-06-06T00:00:00.000Z","2004-06-13T00:00:00.000Z","2004-06-20T00:00:00.000Z","2004-06-27T00:00:00.000Z","2004-07-04T00:00:00.000Z","2004-07-11T00:00:00.000Z","2004-07-18T00:00:00.000Z","2004-07-25T00:00:00.000Z","2004-08-01T00:00:00.000Z","2004-08-08T00:00:00.000Z","2004-08-15T00:00:00.000Z","2004-08-22T00:00:00.000Z","2004-08-29T00:00:00.000Z","2004-09-05T00:00:00.000Z","2004-09-12T00:00:00.000Z","2004-09-19T00:00:00.000Z","2004-09-26T00:00:00.000Z","2004-10-03T00:00:00.000Z","2004-10-10T00:00:00.000Z","2004-10-17T00:00:00.000Z","2004-10-24T00:00:00.000Z","2004-10-31T00:00:00.000Z","2004-11-07T00:00:00.000Z","2004-11-14T00:00:00.000Z","2004-11-21T00:00:00.000Z","2004-11-28T00:00:00.000Z","2004-12-05T00:00:00.000Z","2004-12-12T00:00:00.000Z","2004-12-19T00:00:00.000Z","2004-12-26T00:00:00.000Z"];
    //let timelattice = ["2005-01-02T00:00:00.000Z","2005-01-09T00:00:00.000Z","2005-01-16T00:00:00.000Z","2005-01-23T00:00:00.000Z","2005-01-30T00:00:00.000Z","2005-02-06T00:00:00.000Z","2005-02-13T00:00:00.000Z","2005-02-20T00:00:00.000Z","2005-02-27T00:00:00.000Z","2005-03-06T00:00:00.000Z","2005-03-13T00:00:00.000Z","2005-03-20T00:00:00.000Z","2005-03-27T00:00:00.000Z","2005-04-03T00:00:00.000Z","2005-04-10T00:00:00.000Z","2005-04-17T00:00:00.000Z","2005-04-24T00:00:00.000Z","2005-05-01T00:00:00.000Z","2005-05-08T00:00:00.000Z","2005-05-15T00:00:00.000Z","2005-05-22T00:00:00.000Z","2005-05-29T00:00:00.000Z","2005-06-05T00:00:00.000Z","2005-06-12T00:00:00.000Z","2005-06-19T00:00:00.000Z","2005-06-26T00:00:00.000Z","2005-07-03T00:00:00.000Z","2005-07-10T00:00:00.000Z","2005-07-17T00:00:00.000Z","2005-07-24T00:00:00.000Z","2005-07-31T00:00:00.000Z","2005-08-07T00:00:00.000Z","2005-08-14T00:00:00.000Z","2005-08-21T00:00:00.000Z","2005-08-28T00:00:00.000Z","2005-09-04T00:00:00.000Z","2005-09-11T00:00:00.000Z","2005-09-18T00:00:00.000Z","2005-09-25T00:00:00.000Z","2005-10-02T00:00:00.000Z","2005-10-09T00:00:00.000Z","2005-10-16T00:00:00.000Z","2005-10-23T00:00:00.000Z","2005-10-30T00:00:00.000Z","2005-11-06T00:00:00.000Z","2005-11-13T00:00:00.000Z","2005-11-20T00:00:00.000Z","2005-11-27T00:00:00.000Z","2005-12-04T00:00:00.000Z","2005-12-11T00:00:00.000Z","2005-12-18T00:00:00.000Z","2005-12-25T00:00:00.000Z","2006-01-01T00:00:00.000Z","2006-01-08T00:00:00.000Z","2006-01-15T00:00:00.000Z","2006-01-22T00:00:00.000Z","2006-01-29T00:00:00.000Z","2006-02-05T00:00:00.000Z","2006-02-12T00:00:00.000Z","2006-02-19T00:00:00.000Z","2006-02-26T00:00:00.000Z","2006-03-05T00:00:00.000Z","2006-03-12T00:00:00.000Z","2006-03-19T00:00:00.000Z","2006-03-26T00:00:00.000Z","2006-04-02T00:00:00.000Z","2006-04-09T00:00:00.000Z","2006-04-16T00:00:00.000Z","2006-04-23T00:00:00.000Z","2006-04-30T00:00:00.000Z","2006-05-07T00:00:00.000Z","2006-05-14T00:00:00.000Z","2006-05-21T00:00:00.000Z","2006-05-28T00:00:00.000Z","2006-06-04T00:00:00.000Z","2006-06-11T00:00:00.000Z","2006-06-18T00:00:00.000Z","2006-06-25T00:00:00.000Z","2006-07-02T00:00:00.000Z","2006-07-09T00:00:00.000Z","2006-07-16T00:00:00.000Z","2006-07-23T00:00:00.000Z","2006-07-30T00:00:00.000Z","2006-08-06T00:00:00.000Z","2006-08-13T00:00:00.000Z","2006-08-20T00:00:00.000Z","2006-08-27T00:00:00.000Z","2006-09-03T00:00:00.000Z","2006-09-10T00:00:00.000Z","2006-09-17T00:00:00.000Z","2006-09-24T00:00:00.000Z","2006-10-01T00:00:00.000Z","2006-10-08T00:00:00.000Z","2006-10-15T00:00:00.000Z","2006-10-22T00:00:00.000Z","2006-10-29T00:00:00.000Z","2006-11-05T00:00:00.000Z","2006-11-12T00:00:00.000Z","2006-11-19T00:00:00.000Z","2006-11-26T00:00:00.000Z","2006-12-03T00:00:00.000Z","2006-12-10T00:00:00.000Z","2006-12-17T00:00:00.000Z","2006-12-24T00:00:00.000Z","2006-12-31T00:00:00.000Z"];
    //let timelattice = ["2007-01-07T00:00:00.000Z","2007-01-14T00:00:00.000Z","2007-01-21T00:00:00.000Z","2007-01-28T00:00:00.000Z","2007-02-04T00:00:00.000Z","2007-02-11T00:00:00.000Z","2007-02-18T00:00:00.000Z","2007-02-25T00:00:00.000Z","2007-03-04T00:00:00.000Z","2007-03-11T00:00:00.000Z","2007-03-18T00:00:00.000Z","2007-03-25T00:00:00.000Z","2007-04-01T00:00:00.000Z","2007-04-08T00:00:00.000Z","2007-04-15T00:00:00.000Z","2007-04-22T00:00:00.000Z","2007-04-29T00:00:00.000Z","2007-05-06T00:00:00.000Z","2007-05-13T00:00:00.000Z","2007-05-20T00:00:00.000Z","2007-05-27T00:00:00.000Z","2007-06-03T00:00:00.000Z","2007-06-10T00:00:00.000Z","2007-06-17T00:00:00.000Z","2007-06-24T00:00:00.000Z","2007-07-01T00:00:00.000Z","2007-07-08T00:00:00.000Z","2007-07-15T00:00:00.000Z","2007-07-22T00:00:00.000Z","2007-07-29T00:00:00.000Z","2007-08-05T00:00:00.000Z","2007-08-12T00:00:00.000Z","2007-08-19T00:00:00.000Z","2007-08-26T00:00:00.000Z","2007-09-02T00:00:00.000Z","2007-09-09T00:00:00.000Z","2007-09-16T00:00:00.000Z","2007-09-23T00:00:00.000Z","2007-09-30T00:00:00.000Z","2007-10-07T00:00:00.000Z","2007-10-14T00:00:00.000Z","2007-10-21T00:00:00.000Z","2007-10-28T00:00:00.000Z","2007-11-04T00:00:00.000Z","2007-11-11T00:00:00.000Z","2007-11-18T00:00:00.000Z","2007-11-25T00:00:00.000Z","2007-12-02T00:00:00.000Z","2007-12-09T00:00:00.000Z","2007-12-16T00:00:00.000Z","2007-12-23T00:00:00.000Z","2007-12-30T00:00:00.000Z","2008-01-06T00:00:00.000Z","2008-01-13T00:00:00.000Z","2008-01-20T00:00:00.000Z","2008-01-27T00:00:00.000Z","2008-02-03T00:00:00.000Z","2008-02-10T00:00:00.000Z","2008-02-17T00:00:00.000Z","2008-02-24T00:00:00.000Z","2008-03-02T00:00:00.000Z","2008-03-09T00:00:00.000Z","2008-03-16T00:00:00.000Z","2008-03-23T00:00:00.000Z","2008-03-30T00:00:00.000Z","2008-04-06T00:00:00.000Z","2008-04-13T00:00:00.000Z","2008-04-20T00:00:00.000Z","2008-04-27T00:00:00.000Z","2008-05-04T00:00:00.000Z","2008-05-11T00:00:00.000Z","2008-05-18T00:00:00.000Z","2008-05-25T00:00:00.000Z","2008-06-01T00:00:00.000Z","2008-06-08T00:00:00.000Z","2008-06-15T00:00:00.000Z","2008-06-22T00:00:00.000Z","2008-06-29T00:00:00.000Z","2008-07-06T00:00:00.000Z","2008-07-13T00:00:00.000Z","2008-07-20T00:00:00.000Z","2008-07-27T00:00:00.000Z","2008-08-03T00:00:00.000Z","2008-08-10T00:00:00.000Z","2008-08-17T00:00:00.000Z","2008-08-24T00:00:00.000Z","2008-08-31T00:00:00.000Z","2008-09-07T00:00:00.000Z","2008-09-14T00:00:00.000Z","2008-09-21T00:00:00.000Z","2008-09-28T00:00:00.000Z","2008-10-05T00:00:00.000Z","2008-10-12T00:00:00.000Z","2008-10-19T00:00:00.000Z","2008-10-26T00:00:00.000Z","2008-11-02T00:00:00.000Z","2008-11-09T00:00:00.000Z","2008-11-16T00:00:00.000Z","2008-11-23T00:00:00.000Z","2008-11-30T00:00:00.000Z","2008-12-07T00:00:00.000Z","2008-12-14T00:00:00.000Z","2008-12-21T00:00:00.000Z","2008-12-28T00:00:00.000Z"];


    //let timelattice = ["2009-01-04T00:00:00.000Z","2009-01-11T00:00:00.000Z","2009-01-18T00:00:00.000Z","2009-01-25T00:00:00.000Z","2009-02-01T00:00:00.000Z","2009-02-08T00:00:00.000Z","2009-02-15T00:00:00.000Z","2009-02-22T00:00:00.000Z","2009-03-01T00:00:00.000Z","2009-03-08T00:00:00.000Z","2009-03-15T00:00:00.000Z","2009-03-22T00:00:00.000Z","2009-03-29T00:00:00.000Z","2009-04-05T00:00:00.000Z","2009-04-12T00:00:00.000Z","2009-04-19T00:00:00.000Z","2009-04-26T00:00:00.000Z","2009-05-03T00:00:00.000Z","2009-05-10T00:00:00.000Z","2009-05-17T00:00:00.000Z","2009-05-24T00:00:00.000Z","2009-05-31T00:00:00.000Z","2009-06-07T00:00:00.000Z","2009-06-14T00:00:00.000Z","2009-06-21T00:00:00.000Z","2009-06-28T00:00:00.000Z","2009-07-05T00:00:00.000Z","2009-07-12T00:00:00.000Z","2009-07-19T00:00:00.000Z","2009-07-26T00:00:00.000Z","2009-08-02T00:00:00.000Z","2009-08-09T00:00:00.000Z","2009-08-16T00:00:00.000Z","2009-08-23T00:00:00.000Z","2009-08-30T00:00:00.000Z","2009-09-06T00:00:00.000Z","2009-09-13T00:00:00.000Z","2009-09-20T00:00:00.000Z","2009-09-27T00:00:00.000Z","2009-10-04T00:00:00.000Z","2009-10-11T00:00:00.000Z","2009-10-18T00:00:00.000Z","2009-10-25T00:00:00.000Z","2009-11-01T00:00:00.000Z","2009-11-08T00:00:00.000Z","2009-11-15T00:00:00.000Z","2009-11-22T00:00:00.000Z","2009-11-29T00:00:00.000Z","2009-12-06T00:00:00.000Z","2009-12-13T00:00:00.000Z","2009-12-20T00:00:00.000Z","2009-12-27T00:00:00.000Z","2010-01-03T00:00:00.000Z","2010-01-10T00:00:00.000Z","2010-01-17T00:00:00.000Z","2010-01-24T00:00:00.000Z","2010-01-31T00:00:00.000Z","2010-02-07T00:00:00.000Z","2010-02-14T00:00:00.000Z","2010-02-21T00:00:00.000Z","2010-02-28T00:00:00.000Z","2010-03-07T00:00:00.000Z","2010-03-14T00:00:00.000Z","2010-03-21T00:00:00.000Z","2010-03-28T00:00:00.000Z","2010-04-04T00:00:00.000Z","2010-04-11T00:00:00.000Z","2010-04-18T00:00:00.000Z","2010-04-25T00:00:00.000Z","2010-05-02T00:00:00.000Z","2010-05-09T00:00:00.000Z","2010-05-16T00:00:00.000Z","2010-05-23T00:00:00.000Z","2010-05-30T00:00:00.000Z","2010-06-06T00:00:00.000Z","2010-06-13T00:00:00.000Z","2010-06-20T00:00:00.000Z","2010-06-27T00:00:00.000Z","2010-07-04T00:00:00.000Z","2010-07-11T00:00:00.000Z","2010-07-18T00:00:00.000Z","2010-07-25T00:00:00.000Z","2010-08-01T00:00:00.000Z","2010-08-08T00:00:00.000Z","2010-08-15T00:00:00.000Z","2010-08-22T00:00:00.000Z","2010-08-29T00:00:00.000Z","2010-09-05T00:00:00.000Z","2010-09-12T00:00:00.000Z","2010-09-19T00:00:00.000Z","2010-09-26T00:00:00.000Z","2010-10-03T00:00:00.000Z","2010-10-10T00:00:00.000Z","2010-10-17T00:00:00.000Z","2010-10-24T00:00:00.000Z","2010-10-31T00:00:00.000Z","2010-11-07T00:00:00.000Z","2010-11-14T00:00:00.000Z","2010-11-21T00:00:00.000Z","2010-11-28T00:00:00.000Z","2010-12-05T00:00:00.000Z","2010-12-12T00:00:00.000Z","2010-12-19T00:00:00.000Z","2010-12-26T00:00:00.000Z"]; 
    //let timelattice = ["2011-01-02T00:00:00.000Z","2011-01-09T00:00:00.000Z","2011-01-16T00:00:00.000Z","2011-01-23T00:00:00.000Z","2011-01-30T00:00:00.000Z","2011-02-06T00:00:00.000Z","2011-02-13T00:00:00.000Z","2011-02-20T00:00:00.000Z","2011-02-27T00:00:00.000Z","2011-03-06T00:00:00.000Z","2011-03-13T00:00:00.000Z","2011-03-20T00:00:00.000Z","2011-03-27T00:00:00.000Z","2011-04-03T00:00:00.000Z","2011-04-10T00:00:00.000Z","2011-04-17T00:00:00.000Z","2011-04-24T00:00:00.000Z","2011-05-01T00:00:00.000Z","2011-05-08T00:00:00.000Z","2011-05-15T00:00:00.000Z","2011-05-22T00:00:00.000Z","2011-05-29T00:00:00.000Z","2011-06-05T00:00:00.000Z","2011-06-12T00:00:00.000Z","2011-06-19T00:00:00.000Z","2011-06-26T00:00:00.000Z","2011-07-03T00:00:00.000Z","2011-07-10T00:00:00.000Z","2011-07-17T00:00:00.000Z","2011-07-24T00:00:00.000Z","2011-07-31T00:00:00.000Z","2011-08-07T00:00:00.000Z","2011-08-14T00:00:00.000Z","2011-08-21T00:00:00.000Z","2011-08-28T00:00:00.000Z","2011-09-04T00:00:00.000Z","2011-09-11T00:00:00.000Z","2011-09-18T00:00:00.000Z","2011-09-25T00:00:00.000Z","2011-10-02T00:00:00.000Z","2011-10-09T00:00:00.000Z","2011-10-16T00:00:00.000Z","2011-10-23T00:00:00.000Z","2011-10-30T00:00:00.000Z","2011-11-06T00:00:00.000Z","2011-11-13T00:00:00.000Z","2011-11-20T00:00:00.000Z","2011-11-27T00:00:00.000Z","2011-12-04T00:00:00.000Z","2011-12-11T00:00:00.000Z","2011-12-18T00:00:00.000Z","2011-12-25T00:00:00.000Z","2012-01-01T00:00:00.000Z","2012-01-08T00:00:00.000Z","2012-01-15T00:00:00.000Z","2012-01-22T00:00:00.000Z","2012-01-29T00:00:00.000Z","2012-02-05T00:00:00.000Z","2012-02-12T00:00:00.000Z","2012-02-19T00:00:00.000Z","2012-02-26T00:00:00.000Z","2012-03-04T00:00:00.000Z","2012-03-11T00:00:00.000Z","2012-03-18T00:00:00.000Z","2012-03-25T00:00:00.000Z","2012-04-01T00:00:00.000Z","2012-04-08T00:00:00.000Z","2012-04-15T00:00:00.000Z","2012-04-22T00:00:00.000Z","2012-04-29T00:00:00.000Z","2012-05-06T00:00:00.000Z","2012-05-13T00:00:00.000Z","2012-05-20T00:00:00.000Z","2012-05-27T00:00:00.000Z","2012-06-03T00:00:00.000Z","2012-06-10T00:00:00.000Z","2012-06-17T00:00:00.000Z","2012-06-24T00:00:00.000Z","2012-07-01T00:00:00.000Z","2012-07-08T00:00:00.000Z","2012-07-15T00:00:00.000Z","2012-07-22T00:00:00.000Z","2012-07-29T00:00:00.000Z","2012-08-05T00:00:00.000Z","2012-08-12T00:00:00.000Z","2012-08-19T00:00:00.000Z","2012-08-26T00:00:00.000Z","2012-09-02T00:00:00.000Z","2012-09-09T00:00:00.000Z","2012-09-16T00:00:00.000Z","2012-09-23T00:00:00.000Z","2012-09-30T00:00:00.000Z","2012-10-07T00:00:00.000Z","2012-10-14T00:00:00.000Z","2012-10-21T00:00:00.000Z","2012-10-28T00:00:00.000Z","2012-11-04T00:00:00.000Z","2012-11-11T00:00:00.000Z","2012-11-18T00:00:00.000Z","2012-11-25T00:00:00.000Z","2012-12-02T00:00:00.000Z","2012-12-09T00:00:00.000Z","2012-12-16T00:00:00.000Z","2012-12-23T00:00:00.000Z","2012-12-30T00:00:00.000Z"]; 
    //let timelattice = ["2013-01-06T00:00:00.000Z","2013-01-13T00:00:00.000Z","2013-01-20T00:00:00.000Z","2013-01-27T00:00:00.000Z","2013-02-03T00:00:00.000Z","2013-02-10T00:00:00.000Z","2013-02-17T00:00:00.000Z","2013-02-24T00:00:00.000Z","2013-03-03T00:00:00.000Z","2013-03-10T00:00:00.000Z","2013-03-17T00:00:00.000Z","2013-03-24T00:00:00.000Z","2013-03-31T00:00:00.000Z","2013-04-07T00:00:00.000Z","2013-04-14T00:00:00.000Z","2013-04-21T00:00:00.000Z","2013-04-28T00:00:00.000Z","2013-05-05T00:00:00.000Z","2013-05-12T00:00:00.000Z","2013-05-19T00:00:00.000Z","2013-05-26T00:00:00.000Z","2013-06-02T00:00:00.000Z","2013-06-09T00:00:00.000Z","2013-06-16T00:00:00.000Z","2013-06-23T00:00:00.000Z","2013-06-30T00:00:00.000Z","2013-07-07T00:00:00.000Z","2013-07-14T00:00:00.000Z","2013-07-21T00:00:00.000Z","2013-07-28T00:00:00.000Z","2013-08-04T00:00:00.000Z","2013-08-11T00:00:00.000Z","2013-08-18T00:00:00.000Z","2013-08-25T00:00:00.000Z","2013-09-01T00:00:00.000Z","2013-09-08T00:00:00.000Z","2013-09-15T00:00:00.000Z","2013-09-22T00:00:00.000Z","2013-09-29T00:00:00.000Z","2013-10-06T00:00:00.000Z","2013-10-13T00:00:00.000Z","2013-10-20T00:00:00.000Z","2013-10-27T00:00:00.000Z","2013-11-03T00:00:00.000Z","2013-11-10T00:00:00.000Z","2013-11-17T00:00:00.000Z","2013-11-24T00:00:00.000Z","2013-12-01T00:00:00.000Z","2013-12-08T00:00:00.000Z","2013-12-15T00:00:00.000Z","2013-12-22T00:00:00.000Z","2013-12-29T00:00:00.000Z","2014-01-05T00:00:00.000Z","2014-01-12T00:00:00.000Z","2014-01-19T00:00:00.000Z","2014-01-26T00:00:00.000Z","2014-02-02T00:00:00.000Z","2014-02-09T00:00:00.000Z","2014-02-16T00:00:00.000Z","2014-02-23T00:00:00.000Z","2014-03-02T00:00:00.000Z","2014-03-09T00:00:00.000Z","2014-03-16T00:00:00.000Z","2014-03-23T00:00:00.000Z","2014-03-30T00:00:00.000Z","2014-04-06T00:00:00.000Z","2014-04-13T00:00:00.000Z","2014-04-20T00:00:00.000Z","2014-04-27T00:00:00.000Z","2014-05-04T00:00:00.000Z","2014-05-11T00:00:00.000Z","2014-05-18T00:00:00.000Z","2014-05-25T00:00:00.000Z","2014-06-01T00:00:00.000Z","2014-06-08T00:00:00.000Z","2014-06-15T00:00:00.000Z","2014-06-22T00:00:00.000Z","2014-06-29T00:00:00.000Z","2014-07-06T00:00:00.000Z","2014-07-13T00:00:00.000Z","2014-07-20T00:00:00.000Z","2014-07-27T00:00:00.000Z","2014-08-03T00:00:00.000Z","2014-08-10T00:00:00.000Z","2014-08-17T00:00:00.000Z","2014-08-24T00:00:00.000Z","2014-08-31T00:00:00.000Z","2014-09-07T00:00:00.000Z","2014-09-14T00:00:00.000Z","2014-09-21T00:00:00.000Z","2014-09-28T00:00:00.000Z","2014-10-05T00:00:00.000Z","2014-10-12T00:00:00.000Z","2014-10-19T00:00:00.000Z","2014-10-26T00:00:00.000Z","2014-11-02T00:00:00.000Z","2014-11-09T00:00:00.000Z","2014-11-16T00:00:00.000Z","2014-11-23T00:00:00.000Z","2014-11-30T00:00:00.000Z","2014-12-07T00:00:00.000Z","2014-12-14T00:00:00.000Z","2014-12-21T00:00:00.000Z","2014-12-28T00:00:00.000Z"]; 
    //let timelattice = ["2015-01-04T00:00:00.000Z","2015-01-11T00:00:00.000Z","2015-01-18T00:00:00.000Z","2015-01-25T00:00:00.000Z","2015-02-01T00:00:00.000Z","2015-02-08T00:00:00.000Z","2015-02-15T00:00:00.000Z","2015-02-22T00:00:00.000Z","2015-03-01T00:00:00.000Z","2015-03-08T00:00:00.000Z","2015-03-15T00:00:00.000Z","2015-03-22T00:00:00.000Z","2015-03-29T00:00:00.000Z","2015-04-05T00:00:00.000Z","2015-04-12T00:00:00.000Z","2015-04-19T00:00:00.000Z","2015-04-26T00:00:00.000Z","2015-05-03T00:00:00.000Z","2015-05-10T00:00:00.000Z","2015-05-17T00:00:00.000Z","2015-05-24T00:00:00.000Z","2015-05-31T00:00:00.000Z","2015-06-07T00:00:00.000Z","2015-06-14T00:00:00.000Z","2015-06-21T00:00:00.000Z","2015-06-28T00:00:00.000Z","2015-07-05T00:00:00.000Z","2015-07-12T00:00:00.000Z","2015-07-19T00:00:00.000Z","2015-07-26T00:00:00.000Z","2015-08-02T00:00:00.000Z","2015-08-09T00:00:00.000Z","2015-08-16T00:00:00.000Z","2015-08-23T00:00:00.000Z","2015-08-30T00:00:00.000Z","2015-09-06T00:00:00.000Z","2015-09-13T00:00:00.000Z","2015-09-20T00:00:00.000Z","2015-09-27T00:00:00.000Z","2015-10-04T00:00:00.000Z","2015-10-11T00:00:00.000Z","2015-10-18T00:00:00.000Z","2015-10-25T00:00:00.000Z","2015-11-01T00:00:00.000Z","2015-11-08T00:00:00.000Z","2015-11-15T00:00:00.000Z","2015-11-22T00:00:00.000Z","2015-11-29T00:00:00.000Z","2015-12-06T00:00:00.000Z","2015-12-13T00:00:00.000Z","2015-12-20T00:00:00.000Z","2015-12-27T00:00:00.000Z","2016-01-03T00:00:00.000Z","2016-01-10T00:00:00.000Z","2016-01-17T00:00:00.000Z","2016-01-24T00:00:00.000Z","2016-01-31T00:00:00.000Z","2016-02-07T00:00:00.000Z","2016-02-14T00:00:00.000Z","2016-02-21T00:00:00.000Z","2016-02-28T00:00:00.000Z","2016-03-06T00:00:00.000Z","2016-03-13T00:00:00.000Z","2016-03-20T00:00:00.000Z","2016-03-27T00:00:00.000Z","2016-04-03T00:00:00.000Z","2016-04-10T00:00:00.000Z","2016-04-17T00:00:00.000Z","2016-04-24T00:00:00.000Z","2016-05-01T00:00:00.000Z","2016-05-08T00:00:00.000Z","2016-05-15T00:00:00.000Z","2016-05-22T00:00:00.000Z","2016-05-29T00:00:00.000Z","2016-06-05T00:00:00.000Z","2016-06-12T00:00:00.000Z","2016-06-19T00:00:00.000Z","2016-06-26T00:00:00.000Z","2016-07-03T00:00:00.000Z","2016-07-10T00:00:00.000Z","2016-07-17T00:00:00.000Z","2016-07-24T00:00:00.000Z","2016-07-31T00:00:00.000Z","2016-08-07T00:00:00.000Z","2016-08-14T00:00:00.000Z","2016-08-21T00:00:00.000Z","2016-08-28T00:00:00.000Z","2016-09-04T00:00:00.000Z","2016-09-11T00:00:00.000Z","2016-09-18T00:00:00.000Z","2016-09-25T00:00:00.000Z","2016-10-02T00:00:00.000Z","2016-10-09T00:00:00.000Z","2016-10-16T00:00:00.000Z","2016-10-23T00:00:00.000Z","2016-10-30T00:00:00.000Z","2016-11-06T00:00:00.000Z","2016-11-13T00:00:00.000Z","2016-11-20T00:00:00.000Z","2016-11-27T00:00:00.000Z","2016-12-04T00:00:00.000Z","2016-12-11T00:00:00.000Z","2016-12-18T00:00:00.000Z","2016-12-25T00:00:00.000Z"]; 
    //let timelattice = ["2017-01-01T00:00:00.000Z","2017-01-08T00:00:00.000Z","2017-01-15T00:00:00.000Z","2017-01-22T00:00:00.000Z","2017-01-29T00:00:00.000Z","2017-02-05T00:00:00.000Z","2017-02-12T00:00:00.000Z","2017-02-19T00:00:00.000Z","2017-02-26T00:00:00.000Z","2017-03-05T00:00:00.000Z","2017-03-12T00:00:00.000Z","2017-03-19T00:00:00.000Z","2017-03-26T00:00:00.000Z","2017-04-02T00:00:00.000Z","2017-04-09T00:00:00.000Z","2017-04-16T00:00:00.000Z","2017-04-23T00:00:00.000Z","2017-04-30T00:00:00.000Z","2017-05-07T00:00:00.000Z","2017-05-14T00:00:00.000Z","2017-05-21T00:00:00.000Z","2017-05-28T00:00:00.000Z","2017-06-04T00:00:00.000Z","2017-06-11T00:00:00.000Z","2017-06-18T00:00:00.000Z","2017-06-25T00:00:00.000Z","2017-07-02T00:00:00.000Z","2017-07-09T00:00:00.000Z","2017-07-16T00:00:00.000Z","2017-07-23T00:00:00.000Z","2017-07-30T00:00:00.000Z","2017-08-06T00:00:00.000Z","2017-08-13T00:00:00.000Z","2017-08-20T00:00:00.000Z","2017-08-27T00:00:00.000Z","2017-09-03T00:00:00.000Z","2017-09-10T00:00:00.000Z","2017-09-17T00:00:00.000Z","2017-09-24T00:00:00.000Z","2017-10-01T00:00:00.000Z","2017-10-08T00:00:00.000Z","2017-10-15T00:00:00.000Z","2017-10-22T00:00:00.000Z","2017-10-29T00:00:00.000Z","2017-11-05T00:00:00.000Z","2017-11-12T00:00:00.000Z","2017-11-19T00:00:00.000Z","2017-11-26T00:00:00.000Z","2017-12-03T00:00:00.000Z","2017-12-10T00:00:00.000Z","2017-12-17T00:00:00.000Z","2017-12-24T00:00:00.000Z","2017-12-31T00:00:00.000Z","2018-01-07T00:00:00.000Z","2018-01-14T00:00:00.000Z","2018-01-21T00:00:00.000Z","2018-01-28T00:00:00.000Z","2018-02-04T00:00:00.000Z","2018-02-11T00:00:00.000Z","2018-02-18T00:00:00.000Z","2018-02-25T00:00:00.000Z","2018-03-04T00:00:00.000Z","2018-03-11T00:00:00.000Z","2018-03-18T00:00:00.000Z","2018-03-25T00:00:00.000Z","2018-04-01T00:00:00.000Z","2018-04-08T00:00:00.000Z","2018-04-15T00:00:00.000Z","2018-04-22T00:00:00.000Z","2018-04-29T00:00:00.000Z","2018-05-06T00:00:00.000Z","2018-05-13T00:00:00.000Z","2018-05-20T00:00:00.000Z","2018-05-27T00:00:00.000Z","2018-06-03T00:00:00.000Z","2018-06-10T00:00:00.000Z","2018-06-17T00:00:00.000Z","2018-06-24T00:00:00.000Z","2018-07-01T00:00:00.000Z","2018-07-08T00:00:00.000Z","2018-07-15T00:00:00.000Z","2018-07-22T00:00:00.000Z","2018-07-29T00:00:00.000Z","2018-08-05T00:00:00.000Z","2018-08-12T00:00:00.000Z","2018-08-19T00:00:00.000Z","2018-08-26T00:00:00.000Z","2018-09-02T00:00:00.000Z","2018-09-09T00:00:00.000Z","2018-09-16T00:00:00.000Z","2018-09-23T00:00:00.000Z","2018-09-30T00:00:00.000Z","2018-10-07T00:00:00.000Z","2018-10-14T00:00:00.000Z","2018-10-21T00:00:00.000Z","2018-10-28T00:00:00.000Z","2018-11-04T00:00:00.000Z","2018-11-11T00:00:00.000Z","2018-11-18T00:00:00.000Z","2018-11-25T00:00:00.000Z","2018-12-02T00:00:00.000Z","2018-12-09T00:00:00.000Z","2018-12-16T00:00:00.000Z","2018-12-23T00:00:00.000Z","2018-12-30T00:00:00.000Z"]; 
    //let timelattice = ["2019-01-06T00:00:00.000Z","2019-01-13T00:00:00.000Z","2019-01-20T00:00:00.000Z","2019-01-27T00:00:00.000Z","2019-02-03T00:00:00.000Z","2019-02-10T00:00:00.000Z","2019-02-17T00:00:00.000Z","2019-02-24T00:00:00.000Z","2019-03-03T00:00:00.000Z","2019-03-10T00:00:00.000Z","2019-03-17T00:00:00.000Z","2019-03-24T00:00:00.000Z","2019-03-31T00:00:00.000Z","2019-04-07T00:00:00.000Z","2019-04-14T00:00:00.000Z","2019-04-21T00:00:00.000Z","2019-04-28T00:00:00.000Z","2019-05-05T00:00:00.000Z","2019-05-12T00:00:00.000Z","2019-05-19T00:00:00.000Z","2019-05-26T00:00:00.000Z","2019-06-02T00:00:00.000Z","2019-06-09T00:00:00.000Z","2019-06-16T00:00:00.000Z","2019-06-23T00:00:00.000Z","2019-06-30T00:00:00.000Z","2019-07-07T00:00:00.000Z","2019-07-14T00:00:00.000Z","2019-07-21T00:00:00.000Z","2019-07-28T00:00:00.000Z","2019-08-04T00:00:00.000Z","2019-08-11T00:00:00.000Z","2019-08-18T00:00:00.000Z","2019-08-25T00:00:00.000Z","2019-09-01T00:00:00.000Z","2019-09-08T00:00:00.000Z","2019-09-15T00:00:00.000Z","2019-09-22T00:00:00.000Z","2019-09-29T00:00:00.000Z","2019-10-06T00:00:00.000Z","2019-10-13T00:00:00.000Z","2019-10-20T00:00:00.000Z","2019-10-27T00:00:00.000Z","2019-11-03T00:00:00.000Z","2019-11-10T00:00:00.000Z","2019-11-17T00:00:00.000Z","2019-11-24T00:00:00.000Z","2019-12-01T00:00:00.000Z","2019-12-08T00:00:00.000Z","2019-12-15T00:00:00.000Z","2019-12-22T00:00:00.000Z","2019-12-29T00:00:00.000Z","2020-01-05T00:00:00.000Z","2020-01-12T00:00:00.000Z","2020-01-19T00:00:00.000Z","2020-01-26T00:00:00.000Z","2020-02-02T00:00:00.000Z","2020-02-09T00:00:00.000Z","2020-02-16T00:00:00.000Z","2020-02-23T00:00:00.000Z","2020-03-01T00:00:00.000Z","2020-03-08T00:00:00.000Z","2020-03-15T00:00:00.000Z","2020-03-22T00:00:00.000Z","2020-03-29T00:00:00.000Z","2020-04-05T00:00:00.000Z","2020-04-12T00:00:00.000Z","2020-04-19T00:00:00.000Z","2020-04-26T00:00:00.000Z","2020-05-03T00:00:00.000Z","2020-05-10T00:00:00.000Z","2020-05-17T00:00:00.000Z","2020-05-24T00:00:00.000Z","2020-05-31T00:00:00.000Z","2020-06-07T00:00:00.000Z","2020-06-14T00:00:00.000Z","2020-06-21T00:00:00.000Z","2020-06-28T00:00:00.000Z","2020-07-05T00:00:00.000Z","2020-07-12T00:00:00.000Z","2020-07-19T00:00:00.000Z","2020-07-26T00:00:00.000Z","2020-08-02T00:00:00.000Z","2020-08-09T00:00:00.000Z","2020-08-16T00:00:00.000Z","2020-08-23T00:00:00.000Z","2020-08-30T00:00:00.000Z","2020-09-06T00:00:00.000Z","2020-09-13T00:00:00.000Z","2020-09-20T00:00:00.000Z","2020-09-27T00:00:00.000Z","2020-10-04T00:00:00.000Z","2020-10-11T00:00:00.000Z","2020-10-18T00:00:00.000Z","2020-10-25T00:00:00.000Z","2020-11-01T00:00:00.000Z","2020-11-08T00:00:00.000Z","2020-11-15T00:00:00.000Z","2020-11-22T00:00:00.000Z","2020-11-29T00:00:00.000Z","2020-12-06T00:00:00.000Z","2020-12-13T00:00:00.000Z","2020-12-20T00:00:00.000Z","2020-12-27T00:00:00.000Z"]; 
    let timelattice = ["2021-01-03T00:00:00.000Z","2021-01-10T00:00:00.000Z","2021-01-17T00:00:00.000Z","2021-01-24T00:00:00.000Z","2021-01-31T00:00:00.000Z","2021-02-07T00:00:00.000Z","2021-02-14T00:00:00.000Z","2021-02-21T00:00:00.000Z","2021-02-28T00:00:00.000Z","2021-03-07T00:00:00.000Z","2021-03-14T00:00:00.000Z","2021-03-21T00:00:00.000Z","2021-03-28T00:00:00.000Z","2021-04-04T00:00:00.000Z","2021-04-11T00:00:00.000Z","2021-04-18T00:00:00.000Z","2021-04-25T00:00:00.000Z","2021-05-02T00:00:00.000Z","2021-05-09T00:00:00.000Z","2021-05-16T00:00:00.000Z","2021-05-23T00:00:00.000Z","2021-05-30T00:00:00.000Z","2021-06-06T00:00:00.000Z","2021-06-13T00:00:00.000Z","2021-06-20T00:00:00.000Z","2021-06-27T00:00:00.000Z","2021-07-04T00:00:00.000Z","2021-07-11T00:00:00.000Z","2021-07-18T00:00:00.000Z","2021-07-25T00:00:00.000Z","2021-08-01T00:00:00.000Z","2021-08-08T00:00:00.000Z","2021-08-15T00:00:00.000Z","2021-08-22T00:00:00.000Z","2021-08-29T00:00:00.000Z","2021-09-05T00:00:00.000Z","2021-09-12T00:00:00.000Z","2021-09-19T00:00:00.000Z","2021-09-26T00:00:00.000Z","2021-10-03T00:00:00.000Z","2021-10-10T00:00:00.000Z","2021-10-17T00:00:00.000Z","2021-10-24T00:00:00.000Z","2021-10-31T00:00:00.000Z","2021-11-07T00:00:00.000Z","2021-11-14T00:00:00.000Z","2021-11-21T00:00:00.000Z","2021-11-28T00:00:00.000Z","2021-12-05T00:00:00.000Z","2021-12-12T00:00:00.000Z","2021-12-19T00:00:00.000Z","2021-12-26T00:00:00.000Z","2022-01-02T00:00:00.000Z","2022-01-09T00:00:00.000Z","2022-01-16T00:00:00.000Z","2022-01-23T00:00:00.000Z","2022-01-30T00:00:00.000Z","2022-02-06T00:00:00.000Z","2022-02-13T00:00:00.000Z","2022-02-20T00:00:00.000Z","2022-02-27T00:00:00.000Z","2022-03-06T00:00:00.000Z","2022-03-13T00:00:00.000Z","2022-03-20T00:00:00.000Z","2022-03-27T00:00:00.000Z","2022-04-03T00:00:00.000Z","2022-04-10T00:00:00.000Z","2022-04-17T00:00:00.000Z","2022-04-24T00:00:00.000Z","2022-05-01T00:00:00.000Z","2022-05-08T00:00:00.000Z","2022-05-15T00:00:00.000Z","2022-05-22T00:00:00.000Z","2022-05-29T00:00:00.000Z","2022-06-05T00:00:00.000Z","2022-06-12T00:00:00.000Z","2022-06-19T00:00:00.000Z","2022-06-26T00:00:00.000Z","2022-07-03T00:00:00.000Z","2022-07-10T00:00:00.000Z","2022-07-17T00:00:00.000Z","2022-07-24T00:00:00.000Z","2022-07-31T00:00:00.000Z"];    

    // caluclate intervals in days since 1993-01-01 for all timesteps
    let mut timesteps = Vec::new();
    let epoch = DateTime::parse_from_rfc3339("1993-01-01T00:00:00Z").unwrap();
    for _i in 0..timelattice.len() {
        let dt = DateTime::parse_from_rfc3339(timelattice[_i]).unwrap();
        timesteps.push(dt.signed_duration_since(epoch).num_days());
    }

    // set up a new netcdf file to hold this period's averages
    let mut outfile = netcdf::create("data/ssh_mean_2122.nc")?;
    outfile.add_dimension("latitude", 720)?;
    outfile.add_dimension("longitude", 1440)?;
    outfile.add_dimension("time", timelattice.len())?;

    let mut timeidx = 0;

    // vectors to hold interim results
    let mut meanSLAs: Vec<Vec<Vec<f64>>> = vec![vec![vec![-999.9;1440];720];timelattice.len()];
    let mut nonFillCount: Vec<Vec<Vec<i32>>> = vec![vec![vec![0;1440];720];timelattice.len()];

    for d in timelattice {
        // determine which daily files to average
        let dates = timewindow(d, 3);

        // load upstream data
        for date in dates.iter(){
            let f = netcdf::open(format!("data/dt_global_twosat_phy_l4_{}_vDT2021.nc", date))?;
            let sla = &f.variable("sla").expect("Could not find variable 'sla'");
            for lat in 0..720 {
                for lon in 0..1440 {
                    let v = sla.value::<i64, _>([0, lat, lon])?;
                    if v!= -2147483647 {
                        if meanSLAs[timeidx][lat][lon] == -999.9 {
                            // drop the fill value and start counting real values
                            meanSLAs[timeidx][lat][lon] = 0.0;
                        }
                        meanSLAs[timeidx][lat][lon] += (v as f64) * 0.0001; // account for scale factor here
                        nonFillCount[timeidx][lat][lon] += 1;
                    }
                }
            }
        }

        timeidx += 1;
    }

    // tabulate and record means
    let mut meansla = outfile.add_variable::<f64>("sla",&["time", "latitude", "longitude"])?;
    for time in 0..timeidx{
        for lat in 0..720 {
            let mut msla = Vec::new();
            for lon in 0..1440 {
                if meanSLAs[time][lat][lon] != -999.9 {
                    msla.push(meanSLAs[time][lat][lon] / (nonFillCount[time][lat][lon] as f64));
                } else {
                    msla.push(meanSLAs[time][lat][lon]);
                }
            }
            // write to file
            meansla.put_values(&msla, (time, lat, ..));
        }
    }

    // record how many observations were used to construct each mean
    let mut nobs = outfile.add_variable::<f64>("nobs",&["time", "latitude", "longitude"])?;  // track how many non-fill-value observations the mean is calculated over
    for time in 0..timeidx{
        for lat in 0..720 {
            let mut nobsx = Vec::new();
            for lon in 0..1440 {
                nobsx.push( nonFillCount[time][lat][lon]);
            }
            // write to file
            nobs.put_values(&nobsx, (time, lat, ..));
        }
    }

    // propagate dimensions
    let dates = timewindow(timelattice[0], 3);
    /// latitude
    let f = netcdf::open(format!("data/dt_global_twosat_phy_l4_{}_vDT2021.nc", dates[3]))?;
    let latitudes = &f.variable("latitude").expect("Could not find variable 'latitude'");
    let mut lats = Vec::new();
    for lat in 0..720 {
        lats.push(latitudes.value::<f64, _>([lat])?);
    }
    let mut latvals = outfile.add_variable::<f64>("latitude",&["latitude"])?;
    latvals.put_values(&lats, (0));
    /// longitudes
    let longitudes = &f.variable("longitude").expect("Could not find variable 'longitude'");
    let mut lons = Vec::new();
    for lon in 0..1440 {
        lons.push(longitudes.value::<f64, _>([lon])?);
    }
    let mut lonvals = outfile.add_variable::<f64>("longitude",&["longitude"])?;
    lonvals.put_values(&lons, (0));
    /// timestamps
    let mut timestamps = outfile.add_variable::<i64>("timestamps",&["time"])?;
    timestamps.put_values(&timesteps, (0));

    Ok(())
}